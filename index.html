<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDCash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs (Compatibility Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- ADDED: Firebase Storage for Image Upload -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen gradient-bg">
        <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md m-4">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">BDCash Login</h1>
            <div id="login-form">
                <input type="text" id="login-email" placeholder="Email or Phone Number" class="w-full p-3 mb-4 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-600">
                <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 mb-4 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-600">
                <button onclick="login()" class="w-full bg-purple-600 text-white p-3 rounded-lg font-bold hover:bg-purple-700 transition">Login</button>
                <p class="text-center mt-4 text-gray-600 cursor-pointer hover:underline" onclick="toggleAuth('register')">Don't have an account? Register</p>
            </div>
            <div id="register-form" class="hidden">
                <input type="text" id="reg-username" placeholder="Full Name" class="w-full p-3 mb-4 rounded border border-gray-300">
                <input type="text" id="reg-email" placeholder="Email or Phone Number" class="w-full p-3 mb-4 rounded border border-gray-300">
                <input type="password" id="reg-pass" placeholder="Password" class="w-full p-3 mb-4 rounded border border-gray-300">
                <button onclick="register()" class="w-full bg-green-500 text-white p-3 rounded-lg font-bold hover:bg-green-600 transition">Register</button>
                <p class="text-center mt-4 text-gray-600 cursor-pointer hover:underline" onclick="toggleAuth('login')">Already have an account? Login</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Dialog Modal -->
        <div id="dialog-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg max-w-sm w-full relative m-4">
                <button onclick="closeDialog()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                <h3 id="dialog-title" class="text-xl font-bold text-center mb-2">Announcement</h3>
                <img id="dialog-img" src="" class="w-full h-40 object-cover rounded mb-2 hidden">
                <a id="dialog-link" href="#" target="_blank" class="block w-full text-center bg-blue-500 text-white py-2 rounded hidden">Visit Link</a>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="bg-white shadow-md fixed w-full bottom-0 md:top-0 md:bottom-auto z-40">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16 items-center">
                    <div class="text-2xl font-bold text-purple-600 hidden md:block">BDCash</div>
                    <div class="flex space-x-8 w-full md:w-auto justify-around">
                        <button onclick="showPage('home')" class="text-gray-600 hover:text-purple-600 flex flex-col items-center"><i class="fas fa-home text-xl"></i><span class="text-xs">Home</span></button>
                        <button onclick="showPage('wallet')" class="text-gray-600 hover:text-purple-600 flex flex-col items-center"><i class="fas fa-wallet text-xl"></i><span class="text-xs">Wallet</span></button>
                        <button onclick="showPage('profile')" class="text-gray-600 hover:text-purple-600 flex flex-col items-center"><i class="fas fa-user text-xl"></i><span class="text-xs">Profile</span></button>
                        <button onclick="logout()" class="text-red-500 hover:text-red-700 flex flex-col items-center"><i class="fas fa-sign-out-alt text-xl"></i><span class="text-xs">Logout</span></button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="pt-4 pb-20 md:pt-20 px-4 max-w-4xl mx-auto">
            
            <!-- Homepage: Verification -->
            <div id="home-page" class="page-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Number Verification</h2>
                    
                    <div id="step-number">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Enter Phone Number</label>
                        <div class="flex">
                            <input type="number" id="verify-number" placeholder="017xxxxxxxx" class="flex-1 p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                            <button onclick="submitNumber()" class="bg-purple-600 text-white px-6 rounded-r-lg hover:bg-purple-700">Submit</button>
                        </div>
                    </div>

                    <div id="step-otp" class="hidden mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 text-sm font-bold">Enter OTP</label>
                            <span id="timer" class="text-red-500 font-bold">300s</span>
                        </div>
                        <div class="flex">
                            <input type="number" id="verify-otp" placeholder="XXXXXX" class="flex-1 p-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                            <button onclick="submitOtp()" class="bg-green-500 text-white px-6 rounded-r-lg hover:bg-green-600">Confirm OTP</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Enter the code received on your phone.</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">Verification History</h3>
                    <div id="history-list" class="space-y-3">
                        <!-- Items injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Wallet Page -->
            <div id="wallet-page" class="page-section hidden">
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl shadow-lg p-8 text-white mb-6 text-center">
                    <p class="text-lg opacity-80">Current Balance</p>
                    <h1 class="text-5xl font-bold my-2">৳ <span id="wallet-balance">0</span></h1>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Withdraw Funds</h3>
                    <select id="withdraw-method" class="w-full p-3 border rounded mb-3">
                        <option value="bkash">bKash</option>
                        <option value="nagad">Nagad</option>
                    </select>
                    <input type="number" id="withdraw-number" placeholder="Account Number" class="w-full p-3 border rounded mb-3">
                    <input type="number" id="withdraw-amount" placeholder="Amount (Min ৳100)" class="w-full p-3 border rounded mb-3">
                    <button id="withdraw-btn" onclick="requestWithdraw()" disabled class="w-full bg-gray-400 text-white p-3 rounded font-bold cursor-not-allowed transition">Withdraw</button>
                </div>
                
                <div class="mt-6 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-3">Withdrawal History</h3>
                    <div id="withdraw-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Profile Page (UPDATED WITH UPLOAD) -->
            <div id="profile-page" class="page-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 max-w-md mx-auto">
                    <div class="flex flex-col items-center mb-6">
                        <img id="profile-pic" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full border-4 border-purple-100 object-cover mb-3">
                        <h2 id="profile-name" class="text-xl font-bold">User Name</h2>
                        <p id="profile-email" class="text-gray-500 text-sm">user@email.com</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-bold text-gray-600">Change Name</label>
                            <input type="text" id="update-name" class="w-full p-2 border rounded">
                        </div>
                        
                        <!-- File Upload Section -->
                        <div>
                            <label class="text-sm font-bold text-gray-600">Upload Profile Picture</label>
                            <div class="flex items-center space-x-2">
                                <input type="file" id="update-pic-file" accept="image/*" class="w-full p-2 border rounded bg-gray-50 text-sm">
                            </div>
                            <p id="upload-status" class="text-xs text-blue-600 font-bold mt-1 hidden">
                                <i class="fas fa-spinner fa-spin"></i> Uploading image... please wait.
                            </p>
                        </div>

                        <div>
                            <label class="text-sm font-bold text-gray-600">New Password</label>
                            <input type="password" id="update-pass" class="w-full p-2 border rounded">
                        </div>
                        <button onclick="updateProfile()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Update Profile</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Floating Support -->
        <div class="fixed right-4 bottom-24 flex flex-col space-y-3 z-50">
            <a href="https://t.me/accsell06" target="_blank" class="bg-blue-500 w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 transition">
                <i class="fab fa-telegram-plane text-2xl"></i>
            </a>
            <a href="https://api.whatsapp.com/send?phone=8801612684951&text=Hello" target="_blank" class="bg-green-500 w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 transition">
                <i class="fab fa-whatsapp text-2xl"></i>
            </a>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5plapILmKgaBMJV60i3EuTEtQiS1WUU0",
            authDomain: "bdcash-cf806.firebaseapp.com",
            databaseURL: "https://bdcash-cf806-default-rtdb.firebaseio.com",
            projectId: "bdcash-cf806",
            storageBucket: "bdcash-cf806.appspot.com",
            messagingSenderId: "393200389810",
            appId: "1:393200389810:android:efffb86d11b92f5b5243ab"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage(); // Initialize Storage

        let currentUser = null;
        let currentVerificationKey = null;
        let timerInterval;

        // --- Auth Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                db.ref('users/' + user.uid).on('value', snapshot => {
                    const userData = snapshot.val();
                    if (userData && userData.isBanned) {
                        alert("You are banned from this platform.");
                        auth.signOut();
                    } else {
                        currentUser = user;
                        document.getElementById('auth-container').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        loadUserData(userData);
                        checkForDialog();
                    }
                });
            } else {
                currentUser = null;
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        function formatEmail(input) {
            if (!input.includes('@')) {
                return input + "@sms.com";
            }
            return input;
        }

        function login() {
            const email = formatEmail(document.getElementById('login-email').value);
            const pass = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
        }

        function register() {
            const name = document.getElementById('reg-username').value;
            const email = formatEmail(document.getElementById('reg-email').value);
            const pass = document.getElementById('reg-pass').value;

            if(!name || !email || !pass) return alert("All fields required");

            auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
                db.ref('users/' + cred.user.uid).set({
                    username: name,
                    email: email,
                    balance: 0,
                    profilePic: 'https://via.placeholder.com/150',
                    isBanned: false
                });
                toggleAuth('login');
                alert("Registration Successful! Please Login.");
            }).catch(e => alert(e.message));
        }

        function toggleAuth(view) {
            if (view === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
            }
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        // --- Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
        }

        // --- Data Loading ---
        function loadUserData(data) {
            if(!data) return;
            // Profile
            document.getElementById('profile-name').innerText = data.username;
            document.getElementById('profile-email').innerText = data.email;
            document.getElementById('profile-pic').src = data.profilePic || 'https://via.placeholder.com/150';
            
            document.getElementById('update-name').value = data.username;
            document.getElementById('update-pic-file').value = ""; // Reset file input

            // Wallet
            document.getElementById('wallet-balance').innerText = data.balance;
            const withdrawBtn = document.getElementById('withdraw-btn');
            if (data.balance >= 100) {
                withdrawBtn.disabled = false;
                withdrawBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                withdrawBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            } else {
                withdrawBtn.disabled = true;
                withdrawBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                withdrawBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            }

            // Load History
            loadHistory();
            loadWithdrawals();
        }

        // --- Verification Logic ---
        function submitNumber() {
            const number = document.getElementById('verify-number').value;
            if (number.length < 10) return alert("Invalid Number");

            const newKey = db.ref().child('verifications').push().key;
            currentVerificationKey = newKey;

            db.ref('verifications/' + newKey).set({
                uid: currentUser.uid,
                number: number,
                status: 'pending_otp',
                timestamp: Date.now()
            }).then(() => {
                document.getElementById('step-number').classList.add('hidden');
                document.getElementById('step-otp').classList.remove('hidden');
                startTimer();
            });
        }

        function startTimer() {
            let timeLeft = 300;
            const timerEl = document.getElementById('timer');
            clearInterval(timerInterval); // Clear any existing timer
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft + 's';
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Time expired");
                    resetHome();
                }
            }, 1000);
        }

        function submitOtp() {
            const otp = document.getElementById('verify-otp').value;
            if (!otp) return alert("Enter OTP");
            clearInterval(timerInterval);

            db.ref('verifications/' + currentVerificationKey).update({
                otp: otp,
                status: 'pending_approval'
            }).then(() => {
                alert("OTP Submitted. Admin will verify.");
                resetHome();
            });
        }

        function resetHome() {
            document.getElementById('step-number').classList.remove('hidden');
            document.getElementById('step-otp').classList.add('hidden');
            document.getElementById('verify-number').value = '';
            document.getElementById('verify-otp').value = '';
        }

        function loadHistory() {
            db.ref('verifications').orderByChild('uid').equalTo(currentUser.uid).on('value', snapshot => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                snapshot.forEach(child => {
                    const data = child.val();
                    let color = 'text-yellow-600';
                    let icon = 'fa-clock';
                    if (data.status === 'approved') { color = 'text-green-600'; icon = 'fa-check-circle'; }
                    if (data.status === 'rejected') { color = 'text-red-600'; icon = 'fa-times-circle'; }
                    
                    const html = `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded border-l-4 border-${color.split('-')[1]}-500">
                            <div>
                                <p class="font-bold">${data.number}</p>
                                <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleDateString()}</p>
                            </div>
                            <span class="${color} font-bold text-sm capitalized"><i class="fas ${icon}"></i> ${data.status}</span>
                        </div>
                    `;
                    list.insertAdjacentHTML('afterbegin', html);
                });
            });
        }

        // --- Wallet Logic ---
        function requestWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const number = document.getElementById('withdraw-number').value;

            db.ref('users/' + currentUser.uid + '/balance').once('value', snap => {
                if (snap.val() >= 100 && amount >= 100 && amount <= snap.val()) {
                    db.ref('withdrawals').push({
                        uid: currentUser.uid,
                        amount: amount,
                        method: method,
                        number: number,
                        status: 'pending',
                        timestamp: Date.now()
                    }).then(() => {
                        db.ref('users/' + currentUser.uid).update({
                            balance: snap.val() - amount
                        });
                        alert("Withdrawal requested!");
                        document.getElementById('withdraw-amount').value = '';
                    });
                } else {
                    alert("Insufficient balance or invalid amount.");
                }
            });
        }

        function loadWithdrawals() {
            db.ref('withdrawals').orderByChild('uid').equalTo(currentUser.uid).on('value', snapshot => {
                const list = document.getElementById('withdraw-list');
                list.innerHTML = '';
                snapshot.forEach(child => {
                    const data = child.val();
                    let statusColor = data.status === 'paid' ? 'text-green-600' : (data.status === 'rejected' ? 'text-red-600' : 'text-yellow-600');
                    list.insertAdjacentHTML('afterbegin', `
                        <div class="flex justify-between border-b py-2">
                            <div>
                                <span class="font-bold block">${data.method.toUpperCase()}</span>
                                <span class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleDateString()}</span>
                            </div>
                            <div class="text-right">
                                <span class="block font-bold">৳ ${data.amount}</span>
                                <span class="text-xs ${statusColor} font-bold uppercase">${data.status}</span>
                            </div>
                        </div>
                    `);
                });
            });
        }

        // --- Profile Logic (Updated with Upload) ---
        function updateProfile() {
            const name = document.getElementById('update-name').value;
            const pass = document.getElementById('update-pass').value;
            const fileInput = document.getElementById('update-pic-file');
            const file = fileInput.files[0];
            const statusMsg = document.getElementById('upload-status');

            const updates = { username: name };

            const saveToDb = () => {
                db.ref('users/' + currentUser.uid).update(updates).then(() => {
                    if (pass) {
                        currentUser.updatePassword(pass)
                            .then(() => alert("Profile & Password Updated Successfully!"))
                            .catch(e => alert("Password Error: " + e.message));
                    } else {
                        alert("Profile Updated Successfully!");
                    }
                    statusMsg.classList.add('hidden');
                }).catch(e => {
                    alert("Database Error: " + e.message);
                    statusMsg.classList.add('hidden');
                });
            };

            if (file) {
                statusMsg.classList.remove('hidden'); // Show loader
                
                // Upload to Firebase Storage
                const storageRef = storage.ref();
                const fileRef = storageRef.child('users/' + currentUser.uid + '/profile.jpg');

                fileRef.put(file).then((snapshot) => {
                    return snapshot.ref.getDownloadURL();
                }).then((downloadURL) => {
                    updates.profilePic = downloadURL;
                    saveToDb();
                }).catch((error) => {
                    alert("Image Upload Failed: " + error.message);
                    statusMsg.classList.add('hidden');
                });
            } else {
                saveToDb();
            }
        }

        // --- Dialog Logic ---
        function checkForDialog() {
            db.ref('dialog').on('value', snap => {
                const data = snap.val();
                if (data && data.active) {
                    document.getElementById('dialog-title').innerText = data.title;
                    if(data.image) {
                        document.getElementById('dialog-img').src = data.image;
                        document.getElementById('dialog-img').classList.remove('hidden');
                    }
                    if(data.link) {
                        document.getElementById('dialog-link').href = data.link;
                        document.getElementById('dialog-link').classList.remove('hidden');
                    }
                    document.getElementById('dialog-modal').classList.remove('hidden');
                }
            });
        }
        function closeDialog() {
            document.getElementById('dialog-modal').classList.add('hidden');
        }

    </script>
</body>
</html>
